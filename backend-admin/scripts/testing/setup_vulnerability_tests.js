const admin = require('firebase-admin');
const fs = require('fs');
const { getFirestore } = require('firebase-admin/firestore');

const serviceAccountPath = '/Users/aerguevara/Documents/develop/Adventure Streak/Docs/serviceAccount.json';
const userId = 'DQN1tyypsEZouksWzmFeSIYip7b2'; // Usuario de prueba PRE corregido

if (!fs.existsSync(serviceAccountPath)) {
    console.error('Service account file not found');
    process.exit(1);
}

const serviceAccount = JSON.parse(fs.readFileSync(serviceAccountPath, 'utf8'));

admin.initializeApp({
    credential: admin.credential.cert(serviceAccount)
});

const preDB = getFirestore(admin.app(), 'adventure-streak-pre');

async function setupScenario(type) {
    const cellId = '-1809_20235'; // Celda real del usuario en PRE
    const globalRef = preDB.collection('remote_territories').doc(cellId);
    const userRef = preDB.collection('users').doc(userId).collection('territories').doc(cellId);

    console.log(`--- Configurando Escenario: ${type.toUpperCase()} ---`);

    const data = {
        userId: userId,
        isHotSpot: type === 'hotspot',
        lastConqueredAt: admin.firestore.Timestamp.now(),
        centerLatitude: 40.471, // IFEMA
        centerLongitude: -3.617, // IFEMA
        boundary: [
            { latitude: 40.472, longitude: -3.618 },
            { latitude: 40.472, longitude: -3.616 },
            { latitude: 40.470, longitude: -3.616 },
            { latitude: 40.470, longitude: -3.618 }
        ],
        activityId: 'TEST_ACTIVITY_ID' // Required for ProfileViewModel grouping
    };

    if (type === 'expiring') {
        data.expiresAt = admin.firestore.Timestamp.fromDate(new Date(Date.now() + 2 * 60 * 60 * 1000));
    } else if (type === 'expired') {
        data.expiresAt = admin.firestore.Timestamp.fromDate(new Date(Date.now() - 5 * 60 * 1000));
        data.isHotSpot = false;
    } else if (type === 'defense_ready') {
        data.expiresAt = admin.firestore.Timestamp.fromDate(new Date(Date.now() + 5 * 60 * 60 * 1000));
    } else {
        data.expiresAt = admin.firestore.Timestamp.fromDate(new Date(Date.now() + 86400000 * 5));
    }

    await globalRef.set(data, { merge: true });
    await userRef.set(data, { merge: true });

    console.log(`âœ… Celda ${cellId} actualizada en ambas colecciones.`);
    process.exit(0);
}

const arg = process.argv[2];
if (!arg) {
    console.log('Uso: node setup_vulnerability_tests.js [hotspot|expiring|defense_ready]');
    process.exit(1);
}

setupScenario(arg).catch(console.error);
